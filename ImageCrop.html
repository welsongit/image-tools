<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图像裁剪与调整工具 - 图像工具箱</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f7f9fc;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #4285f4;
            margin-bottom: 10px;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .upload-container {
            border: 2px dashed #ccc;
            padding: 40px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
        }
        
        .upload-container.dragover {
            border-color: #4285f4;
            background-color: #e8f0fe;
        }
        
        .upload-container p {
            margin-bottom: 20px;
            color: #666;
        }
        
        #fileInput {
            display: none;
        }
        
        .btn {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            display: inline-block;
        }
        
        .btn:hover {
            background-color: #3367d6;
        }
        
        .btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .editor-container {
            display: none;
            margin-top: 20px;
        }
        
        .editor-wrapper {
            position: relative;
            max-width: 100%;
            margin: 0 auto;
            overflow: hidden;
            background-color: #f0f0f0;
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc),
                              linear-gradient(45deg, #ccc 25%, transparent 25%, transparent 75%, #ccc 75%, #ccc);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }
        
        .crop-container {
            position: relative;
            max-width: 100%;
            max-height: 500px;
            overflow: hidden;
            cursor: move;
        }
        
        #imageCanvas {
            display: block;
            max-width: 100%;
        }
        
        .crop-box {
            position: absolute;
            border: 2px dashed #fff;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            cursor: move;
        }
        
        .resize-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: #fff;
            border: 1px solid #4285f4;
        }
        
        .resize-handle.nw {
            top: -5px;
            left: -5px;
            cursor: nwse-resize;
        }
        
        .resize-handle.ne {
            top: -5px;
            right: -5px;
            cursor: nesw-resize;
        }
        
        .resize-handle.sw {
            bottom: -5px;
            left: -5px;
            cursor: nesw-resize;
        }
        
        .resize-handle.se {
            bottom: -5px;
            right: -5px;
            cursor: nwse-resize;
        }
        
        .toolbar {
            display: flex;
            flex-wrap: nowrap;
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 5px;
            justify-content: space-between;
            overflow-x: auto;
        }
        
        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        .toolbar-group label {
            font-weight: 500;
        }
        
        .toolbar-button {
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 6px 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .toolbar-button:hover {
            background-color: #e7e7e7;
        }
        
        .toolbar-button.active {
            background-color: #e1f5fe;
            border-color: #4285f4;
            color: #4285f4;
        }
        
        .preview-container {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        
        #previewImage {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .result-actions {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        
        .dimensions-display {
            margin-top: 10px;
            text-align: center;
            font-size: 14px;
            color: #666;
        }
        
        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: #4285f4;
            text-decoration: none;
            text-align: center;
            width: 100%;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        @media (max-width: 768px) {
            .toolbar {
                flex-wrap: nowrap;
                overflow-x: auto;
                justify-content: flex-start;
                padding: 12px;
            }
            
            .toolbar-group {
                margin-right: 0;
                margin-bottom: 0;
                flex-shrink: 0;
            }
            
            .toolbar-button {
                padding: 6px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="upload-container" id="dropArea">
            <p>点击或拖拽图片到此处上传（支持JPG、PNG、GIF、WebP格式）</p>
            <input type="file" id="fileInput" accept="image/*">
            <button class="btn" id="uploadBtn">选择图片</button>
        </div>
        
        <div class="editor-container" id="editorContainer">
            <div class="toolbar">
                <div class="toolbar-group">
                    <label>裁剪比例:</label>
                    <select id="aspectRatio">
                        <option value="free">自由</option>
                        <option value="1:1">1:1</option>
                        <option value="4:3">4:3</option>
                        <option value="16:9">16:9</option>
                        <option value="3:2">3:2</option>
                        <option value="2:3">2:3</option>
                    </select>
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-button" id="rotateLeftBtn" title="向左旋转90°">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12C2 16.97 6.03 21 11 21C13.39 21 15.68 20.06 17.4 18.4L15.9 16.9C14.63 18.25 12.86 19 11 19C7.13 19 4 15.87 4 12S7.13 5 11 5C14.87 5 18 8.13 18 12H15L19 16L23 12H20C20 7.03 15.97 3 11 3C6.03 3 2 7.03 2 12Z"/></svg>
                        旋转左
                    </button>
                    <button class="toolbar-button" id="rotateRightBtn" title="向右旋转90°">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12C22 16.97 17.97 21 13 21C10.61 21 8.32 20.06 6.6 18.4L8.1 16.9C9.37 18.25 11.14 19 13 19C16.87 19 20 15.87 20 12S16.87 5 13 5C9.13 5 6 8.13 6 12H9L5 16L1 12H4C4 7.03 8.03 3 13 3C17.97 3 22 7.03 22 12Z"/></svg>
                        旋转右
                    </button>
                    <button class="toolbar-button" id="flipHorizontalBtn" title="水平翻转">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 2L17 2L17 22L7 22L7 2Z"/><path d="M2 12L7 12"/><path d="M17 12L22 12"/></svg>
                        水平翻
                    </button>
                    <button class="toolbar-button" id="flipVerticalBtn" title="垂直翻转">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 7L22 7L22 17L2 17L2 7Z"/><path d="M12 2L12 7"/><path d="M12 17L12 22"/></svg>
                        垂直翻
                    </button>
                </div>
                
                <div class="toolbar-group">
                    <button class="toolbar-button" id="reuploadBtn" title="重新上传图片">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        上传
                    </button>
                    <button class="btn" id="cropBtn">裁剪图像</button>
                </div>
            </div>
            
            <div class="editor-wrapper">
                <div class="crop-container" id="cropContainer">
                    <canvas id="imageCanvas"></canvas>
                    <div class="crop-box" id="cropBox">
                        <div class="resize-handle nw" id="nwHandle"></div>
                        <div class="resize-handle ne" id="neHandle"></div>
                        <div class="resize-handle sw" id="swHandle"></div>
                        <div class="resize-handle se" id="seHandle"></div>
                    </div>
                </div>
            </div>
            
            <div class="dimensions-display">
                选区尺寸: <span id="cropDimensions">0 × 0</span> 像素
            </div>
        </div>
        
        <div class="preview-container" id="previewContainer">
            <h3>裁剪结果</h3>
            <img id="previewImage" alt="裁剪后的图像">
            <div class="dimensions-display">
                图像尺寸: <span id="finalDimensions">0 × 0</span> 像素
            </div>
            <div class="result-actions">
                <button class="btn" id="downloadBtn">下载图像</button>
                <button class="btn" id="resetBtn">重新编辑</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 获取DOM元素
            const fileInput = document.getElementById('fileInput');
            const uploadBtn = document.getElementById('uploadBtn');
            const dropArea = document.getElementById('dropArea');
            const editorContainer = document.getElementById('editorContainer');
            const imageCanvas = document.getElementById('imageCanvas');
            const ctx = imageCanvas.getContext('2d');
            const cropContainer = document.getElementById('cropContainer');
            const cropBox = document.getElementById('cropBox');
            const nwHandle = document.getElementById('nwHandle');
            const neHandle = document.getElementById('neHandle');
            const swHandle = document.getElementById('swHandle');
            const seHandle = document.getElementById('seHandle');
            const aspectRatioSelect = document.getElementById('aspectRatio');
            const rotateLeftBtn = document.getElementById('rotateLeftBtn');
            const rotateRightBtn = document.getElementById('rotateRightBtn');
            const flipHorizontalBtn = document.getElementById('flipHorizontalBtn');
            const flipVerticalBtn = document.getElementById('flipVerticalBtn');
            const cropBtn = document.getElementById('cropBtn');
            const previewContainer = document.getElementById('previewContainer');
            const previewImage = document.getElementById('previewImage');
            const downloadBtn = document.getElementById('downloadBtn');
            const resetBtn = document.getElementById('resetBtn');
            const cropDimensions = document.getElementById('cropDimensions');
            const finalDimensions = document.getElementById('finalDimensions');
            
            // 状态变量
            let originalImage = null;
            let isHorizontalFlipped = false;
            let isVerticalFlipped = false;
            let rotationAngle = 0;
            let cropBoxInitialized = false;
            let canvasScale = 1; // 添加画布缩放比例变量
            
            // 上传按钮点击事件
            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });
            
            // 重新上传按钮事件
            const reuploadBtn = document.getElementById('reuploadBtn');
            reuploadBtn.addEventListener('click', () => {
                // 清空之前的选择，确保相同文件可以再次触发change事件
                fileInput.value = '';
                fileInput.click();
            });
            
            // 文件选择事件
            fileInput.addEventListener('change', handleFileSelect);
            
            // 拖放事件处理
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });
            
            dropArea.addEventListener('drop', handleDrop, false);
            
            // 旋转和翻转事件
            rotateLeftBtn.addEventListener('click', () => rotateImage(-90));
            rotateRightBtn.addEventListener('click', () => rotateImage(90));
            flipHorizontalBtn.addEventListener('click', flipHorizontal);
            flipVerticalBtn.addEventListener('click', flipVertical);
            
            // 裁剪比例变更事件
            aspectRatioSelect.addEventListener('change', updateCropBoxAspectRatio);
            
            // 裁剪按钮事件
            cropBtn.addEventListener('click', cropImage);
            
            // 下载按钮事件
            downloadBtn.addEventListener('click', downloadImage);
            
            // 重置按钮事件
            resetBtn.addEventListener('click', resetEditor);
            
            // 防止默认行为
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            // 高亮拖放区域
            function highlight() {
                dropArea.classList.add('dragover');
            }
            
            // 取消高亮拖放区域
            function unhighlight() {
                dropArea.classList.remove('dragover');
            }
            
            // 处理拖放
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }
            
            // 处理文件选择
            function handleFileSelect(e) {
                const files = e.target.files;
                handleFiles(files);
            }
            
            // 处理文件
            function handleFiles(files) {
                if (files.length > 0) {
                    const file = files[0];
                    
                    if (!file.type.match('image.*')) {
                        alert('请上传图片文件！');
                        return;
                    }
                    
                    // 显示编辑器容器
                    dropArea.style.display = 'none';
                    editorContainer.style.display = 'block';
                    previewContainer.style.display = 'none';
                    
                    // 显示加载中提示
                    const loadingMessage = document.createElement('div');
                    loadingMessage.id = 'loadingMessage';
                    loadingMessage.style.position = 'absolute';
                    loadingMessage.style.top = '50%';
                    loadingMessage.style.left = '50%';
                    loadingMessage.style.transform = 'translate(-50%, -50%)';
                    loadingMessage.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                    loadingMessage.style.color = 'white';
                    loadingMessage.style.padding = '10px 20px';
                    loadingMessage.style.borderRadius = '5px';
                    loadingMessage.textContent = '图片加载中...';
                    cropContainer.appendChild(loadingMessage);
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        originalImage = new Image();
                        originalImage.onload = function() {
                            console.log("图片加载成功，尺寸：", originalImage.width, "x", originalImage.height);
                            // 重置状态
                            isHorizontalFlipped = false;
                            isVerticalFlipped = false;
                            rotationAngle = 0;
                            cropBoxInitialized = false;
                            
                            // 重置初始缩放计算标志，确保新图像重新计算缩放比例
                            window.initialScaleCalculated = false;
                            
                            // 设置画布尺寸
                            initializeCanvas();
                            
                            // 移除加载中提示
                            const loadingMsg = document.getElementById('loadingMessage');
                            if (loadingMsg) {
                                loadingMsg.remove();
                            }
                            
                            // 初始化裁剪框
                            initializeCropBox();
                        };
                        originalImage.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            // 初始化画布
            function initializeCanvas() {
                // 确定画布尺寸
                let canvasWidth, canvasHeight;
                
                // 根据旋转角度决定画布尺寸
                if (rotationAngle % 180 === 0) {
                    canvasWidth = originalImage.width;
                    canvasHeight = originalImage.height;
                } else {
                    canvasWidth = originalImage.height;
                    canvasHeight = originalImage.width;
                }
                
                // 设置最大尺寸限制
                const containerWidth = cropContainer.clientWidth;
                const maxHeight = 500; // 固定最大高度
                
                // 静态维持初始缩放比例，避免每次旋转都重新计算缩放导致图片变小
                if (!window.initialScaleCalculated && originalImage) {
                    // 预先考虑旋转后的情况，确保无论旋转与否，图片都能完全显示
                    let initialScalePortrait, initialScaleLandscape;
                    
                    // 横向计算（原始方向）
                    initialScaleLandscape = Math.min(containerWidth / originalImage.width, maxHeight / originalImage.height);
                    
                    // 纵向计算（旋转90度后）
                    initialScalePortrait = Math.min(containerWidth / originalImage.height, maxHeight / originalImage.width);
                    
                    // 取最小值确保所有情况下都完全显示
                    window.initialScale = Math.min(initialScaleLandscape, initialScalePortrait);
                    window.initialScaleCalculated = true;
                    console.log("初始缩放比例计算为：", window.initialScale);
                }
                
                // 使用初始缩放比例
                canvasScale = window.initialScale;
                
                // 设置画布尺寸
                imageCanvas.width = canvasWidth * canvasScale;
                imageCanvas.height = canvasHeight * canvasScale;
                
                console.log("画布尺寸：", imageCanvas.width, "x", imageCanvas.height, "缩放比例：", canvasScale);
                
                // 绘制图像
                drawImage();
                
                // 根据旋转后的画布大小调整容器尺寸
                cropContainer.style.width = imageCanvas.width + "px";
                cropContainer.style.height = imageCanvas.height + "px";
                
                // 确保编辑器包装容器适应画布大小变化
                const editorWrapper = document.querySelector('.editor-wrapper');
                if (editorWrapper) {
                    editorWrapper.style.width = imageCanvas.width + "px";
                    editorWrapper.style.height = imageCanvas.height + "px";
                    editorWrapper.style.margin = "0 auto"; // 保持居中
                }
            }
            
            // 绘制图像
            function drawImage() {
                if (!originalImage) return;
                
                ctx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
                
                // 保存当前状态
                ctx.save();
                
                // 设置变换中心点
                ctx.translate(imageCanvas.width / 2, imageCanvas.height / 2);
                
                // 应用旋转
                ctx.rotate((rotationAngle * Math.PI) / 180);
                
                // 应用翻转
                ctx.scale(isHorizontalFlipped ? -1 : 1, isVerticalFlipped ? -1 : 1);
                
                // 绘制图像 - 根据旋转角度决定如何绘制
                let drawWidth, drawHeight;
                
                if (rotationAngle % 180 === 0) {
                    drawWidth = originalImage.width * canvasScale;
                    drawHeight = originalImage.height * canvasScale;
                } else {
                    // 旋转90°/270°时交换宽高
                    drawWidth = originalImage.height * canvasScale;
                    drawHeight = originalImage.width * canvasScale;
                }
                
                ctx.drawImage(
                    originalImage, 
                    -drawWidth / 2, 
                    -drawHeight / 2, 
                    drawWidth, 
                    drawHeight
                );
                
                // 恢复状态
                ctx.restore();
                
                console.log("图像已绘制，绘制尺寸：", drawWidth, "x", drawHeight);
            }
            
            // 初始化裁剪框
            function initializeCropBox() {
                // 确保裁剪框不超过画布尺寸
                let maxWidth = Math.min(imageCanvas.width * 0.95, imageCanvas.width - 10);
                let maxHeight = Math.min(imageCanvas.height * 0.95, imageCanvas.height - 10);
                
                // 设置裁剪框大小为画布的75%，但不超过最大限制
                let cropWidth = Math.min(imageCanvas.width * 0.75, maxWidth);
                let cropHeight;
                
                if (aspectRatioSelect.value === 'free') {
                    cropHeight = Math.min(imageCanvas.height * 0.75, maxHeight);
                } else {
                    const aspectRatio = getAspectRatioValue();
                    cropHeight = cropWidth / aspectRatio;
                    
                    // 确保高度不超出画布
                    if (cropHeight > maxHeight) {
                        cropHeight = maxHeight;
                        // 根据固定比例调整宽度
                        cropWidth = cropHeight * aspectRatio;
                        if (cropWidth > maxWidth) {
                            cropWidth = maxWidth;
                            cropHeight = cropWidth / aspectRatio;
                        }
                    }
                }
                
                // 确保裁剪框至少有最小尺寸
                const minSize = 50;
                cropWidth = Math.max(cropWidth, minSize);
                cropHeight = Math.max(cropHeight, minSize);
                
                // 确保裁剪框完全在画布内
                cropWidth = Math.min(cropWidth, imageCanvas.width);
                cropHeight = Math.min(cropHeight, imageCanvas.height);
                
                // 设置裁剪框位置居中
                const cropLeft = Math.max(0, (imageCanvas.width - cropWidth) / 2);
                const cropTop = Math.max(0, (imageCanvas.height - cropHeight) / 2);
                
                // 应用裁剪框位置和大小
                cropBox.style.left = cropLeft + 'px';
                cropBox.style.top = cropTop + 'px';
                cropBox.style.width = cropWidth + 'px';
                cropBox.style.height = cropHeight + 'px';
                
                console.log("裁剪框初始化：", cropLeft, cropTop, cropWidth, cropHeight);
                
                // 更新裁剪框尺寸显示
                updateCropDimensions();
                
                // 设置裁剪框为已初始化
                cropBoxInitialized = true;
                
                // 设置裁剪框拖动和调整大小事件
                setupCropBoxEvents();
            }
            
            // 设置裁剪框事件
            function setupCropBoxEvents() {
                let isDragging = false;
                let isResizing = false;
                let resizeHandle = null;
                let startX, startY;
                let startLeft, startTop, startWidth, startHeight;
                
                // 裁剪框拖动
                cropBox.addEventListener('mousedown', function(e) {
                    if (e.target === cropBox) {
                        isDragging = true;
                        startX = e.clientX;
                        startY = e.clientY;
                        startLeft = parseInt(cropBox.style.left) || 0;
                        startTop = parseInt(cropBox.style.top) || 0;
                        e.preventDefault();
                        console.log("开始拖动裁剪框", startLeft, startTop);
                    }
                });
                
                // 添加触摸支持
                cropBox.addEventListener('touchstart', function(e) {
                    if (e.target === cropBox) {
                        isDragging = true;
                        startX = e.touches[0].clientX;
                        startY = e.touches[0].clientY;
                        startLeft = parseInt(cropBox.style.left) || 0;
                        startTop = parseInt(cropBox.style.top) || 0;
                        e.preventDefault();
                    }
                });
                
                // 调整大小
                [nwHandle, neHandle, swHandle, seHandle].forEach(handle => {
                    handle.addEventListener('mousedown', function(e) {
                        isResizing = true;
                        resizeHandle = handle;
                        startX = e.clientX;
                        startY = e.clientY;
                        startLeft = parseInt(cropBox.style.left) || 0;
                        startTop = parseInt(cropBox.style.top) || 0;
                        startWidth = parseInt(cropBox.style.width) || 100;
                        startHeight = parseInt(cropBox.style.height) || 100;
                        e.preventDefault();
                        e.stopPropagation();
                        console.log("开始调整裁剪框大小", startLeft, startTop, startWidth, startHeight);
                    });
                    
                    // 添加触摸支持
                    handle.addEventListener('touchstart', function(e) {
                        isResizing = true;
                        resizeHandle = handle;
                        startX = e.touches[0].clientX;
                        startY = e.touches[0].clientY;
                        startLeft = parseInt(cropBox.style.left) || 0;
                        startTop = parseInt(cropBox.style.top) || 0;
                        startWidth = parseInt(cropBox.style.width) || 100;
                        startHeight = parseInt(cropBox.style.height) || 100;
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });
                
                // 鼠标移动事件
                document.addEventListener('mousemove', function(e) {
                    handleMove(e.clientX, e.clientY);
                });
                
                // 触摸移动事件
                document.addEventListener('touchmove', function(e) {
                    handleMove(e.touches[0].clientX, e.touches[0].clientY);
                }, { passive: false });
                
                function handleMove(clientX, clientY) {
                    if (isDragging) {
                        // 计算新位置
                        let newLeft = startLeft + (clientX - startX);
                        let newTop = startTop + (clientY - startY);
                        
                        // 限制范围
                        newLeft = Math.max(0, Math.min(newLeft, imageCanvas.width - parseInt(cropBox.style.width || 0)));
                        newTop = Math.max(0, Math.min(newTop, imageCanvas.height - parseInt(cropBox.style.height || 0)));
                        
                        // 应用新位置
                        cropBox.style.left = newLeft + 'px';
                        cropBox.style.top = newTop + 'px';
                        
                        // 更新裁剪框尺寸显示
                        updateCropDimensions();
                    } else if (isResizing) {
                        let newWidth, newHeight, newLeft, newTop;
                        const aspectRatio = aspectRatioSelect.value === 'free' ? null : getAspectRatioValue();
                        
                        // 根据调整句柄计算新尺寸
                        if (resizeHandle === seHandle) { // 右下
                            newWidth = startWidth + (clientX - startX);
                            newWidth = Math.max(50, Math.min(newWidth, imageCanvas.width - startLeft));
                            
                            if (aspectRatio) {
                                newHeight = newWidth / aspectRatio;
                            } else {
                                newHeight = startHeight + (clientY - startY);
                            }
                            
                            newHeight = Math.max(50, Math.min(newHeight, imageCanvas.height - startTop));
                            
                            if (aspectRatio && newHeight > imageCanvas.height - startTop) {
                                newHeight = imageCanvas.height - startTop;
                                newWidth = newHeight * aspectRatio;
                            }
                            
                            cropBox.style.width = newWidth + 'px';
                            cropBox.style.height = newHeight + 'px';
                        } else if (resizeHandle === swHandle) { // 左下
                            newWidth = startWidth - (clientX - startX);
                            newLeft = startLeft + (clientX - startX);
                            
                            if (newLeft < 0) {
                                newWidth = startWidth + startLeft;
                                newLeft = 0;
                            }
                            
                            newWidth = Math.max(50, newWidth);
                            
                            if (aspectRatio) {
                                newHeight = newWidth / aspectRatio;
                            } else {
                                newHeight = startHeight + (clientY - startY);
                            }
                            
                            newHeight = Math.max(50, Math.min(newHeight, imageCanvas.height - startTop));
                            
                            if (aspectRatio && newHeight > imageCanvas.height - startTop) {
                                newHeight = imageCanvas.height - startTop;
                                newWidth = newHeight * aspectRatio;
                                newLeft = startLeft + startWidth - newWidth;
                            }
                            
                            cropBox.style.left = newLeft + 'px';
                            cropBox.style.width = newWidth + 'px';
                            cropBox.style.height = newHeight + 'px';
                        } else if (resizeHandle === neHandle) { // 右上
                            newWidth = startWidth + (clientX - startX);
                            newWidth = Math.max(50, Math.min(newWidth, imageCanvas.width - startLeft));
                            
                            if (aspectRatio) {
                                newHeight = newWidth / aspectRatio;
                            } else {
                                newHeight = startHeight - (clientY - startY);
                            }
                            
                            newTop = startTop + (clientY - startY);
                            
                            if (newTop < 0) {
                                newHeight = startHeight + startTop;
                                newTop = 0;
                            }
                            
                            newHeight = Math.max(50, newHeight);
                            
                            if (aspectRatio) {
                                if (newTop < 0) {
                                    newTop = 0;
                                    newHeight = startHeight + startTop;
                                    newWidth = newHeight * aspectRatio;
                                } else {
                                    newTop = startTop + startHeight - newHeight;
                                }
                            }
                            
                            cropBox.style.top = newTop + 'px';
                            cropBox.style.width = newWidth + 'px';
                            cropBox.style.height = newHeight + 'px';
                        } else if (resizeHandle === nwHandle) { // 左上
                            newWidth = startWidth - (clientX - startX);
                            newLeft = startLeft + (clientX - startX);
                            
                            if (newLeft < 0) {
                                newWidth = startWidth + startLeft;
                                newLeft = 0;
                            }
                            
                            newWidth = Math.max(50, newWidth);
                            
                            if (aspectRatio) {
                                newHeight = newWidth / aspectRatio;
                            } else {
                                newHeight = startHeight - (clientY - startY);
                            }
                            
                            newTop = startTop + (clientY - startY);
                            
                            if (newTop < 0) {
                                newHeight = startHeight + startTop;
                                newTop = 0;
                            }
                            
                            newHeight = Math.max(50, newHeight);
                            
                            if (aspectRatio) {
                                if (newTop < 0) {
                                    newTop = 0;
                                    newHeight = startHeight + startTop;
                                    newWidth = newHeight * aspectRatio;
                                    newLeft = startLeft + startWidth - newWidth;
                                } else {
                                    newTop = startTop + startHeight - newHeight;
                                }
                            }
                            
                            cropBox.style.top = newTop + 'px';
                            cropBox.style.left = newLeft + 'px';
                            cropBox.style.width = newWidth + 'px';
                            cropBox.style.height = newHeight + 'px';
                        }
                        
                        // 更新裁剪框尺寸显示
                        updateCropDimensions();
                    }
                }
                
                // 鼠标释放事件
                document.addEventListener('mouseup', function() {
                    if (isDragging || isResizing) {
                        console.log("停止拖动/调整大小");
                    }
                    isDragging = false;
                    isResizing = false;
                    resizeHandle = null;
                });
                
                // 触摸结束事件
                document.addEventListener('touchend', function() {
                    isDragging = false;
                    isResizing = false;
                    resizeHandle = null;
                });
            }
            
            // 更新裁剪框位置
            function updateCropBoxPosition() {
                if (!cropBoxInitialized) return;
                
                // 重新计算裁剪框位置，确保不超出画布
                let cropLeft = parseInt(cropBox.style.left) || 0;
                let cropTop = parseInt(cropBox.style.top) || 0;
                let cropWidth = parseInt(cropBox.style.width) || 100;
                let cropHeight = parseInt(cropBox.style.height) || 100;
                
                // 限制范围
                cropLeft = Math.max(0, Math.min(cropLeft, imageCanvas.width - cropWidth));
                cropTop = Math.max(0, Math.min(cropTop, imageCanvas.height - cropHeight));
                
                // 应用位置
                cropBox.style.left = cropLeft + 'px';
                cropBox.style.top = cropTop + 'px';
                
                // 更新裁剪框尺寸显示
                updateCropDimensions();
            }
            
            // 旋转图像
            function rotateImage(angle) {
                // 保存当前裁剪框的相关信息
                const prevAngle = rotationAngle;
                let cropRatio = 1;
                let cropCenterRelativeX = 0;
                let cropCenterRelativeY = 0;
                
                if (cropBoxInitialized) {
                    const cropWidth = parseInt(cropBox.style.width) || 0;
                    const cropHeight = parseInt(cropBox.style.height) || 0;
                    const cropLeft = parseInt(cropBox.style.left) || 0;
                    const cropTop = parseInt(cropBox.style.top) || 0;
                    
                    // 保存裁剪框的纵横比
                    cropRatio = cropWidth / cropHeight;
                    
                    // 计算裁剪框中心点相对于画布中心的位置（标准化为-1到1的范围）
                    const canvasCenterX = imageCanvas.width / 2;
                    const canvasCenterY = imageCanvas.height / 2;
                    const cropCenterX = cropLeft + cropWidth / 2;
                    const cropCenterY = cropTop + cropHeight / 2;
                    
                    cropCenterRelativeX = (cropCenterX - canvasCenterX) / canvasCenterX;
                    cropCenterRelativeY = (cropCenterY - canvasCenterY) / canvasCenterY;
                    
                    console.log("保存裁剪框信息 - 比例:", cropRatio, "相对位置:", cropCenterRelativeX, cropCenterRelativeY);
                }
                
                // 更新旋转角度
                rotationAngle = (rotationAngle + angle) % 360;
                if (rotationAngle < 0) rotationAngle += 360;
                console.log("旋转角度更新为：", rotationAngle);
                
                // 重新初始化画布
                initializeCanvas();
                
                // 重新创建裁剪框
                cropBoxInitialized = false;
                initializeCropBox();
                
                // 如果之前有裁剪框，调整其位置和尺寸
                if (cropRatio !== 1) {
                    const cropWidth = parseInt(cropBox.style.width) || 0;
                    const cropHeight = parseInt(cropBox.style.height) || 0;
                    
                    let newWidth, newHeight;
                    
                    // 如果旋转了90°或270°，需要交换宽高比
                    if ((rotationAngle - prevAngle) % 180 !== 0) {
                        cropRatio = 1 / cropRatio;
                    }
                    
                    // 根据裁剪框比例计算新的尺寸
                    if (aspectRatioSelect.value === 'free') {
                        if (cropRatio >= 1) {
                            newWidth = cropWidth;
                            newHeight = newWidth / cropRatio;
                        } else {
                            newHeight = cropHeight;
                            newWidth = newHeight * cropRatio;
                        }
                        
                        // 确保不超出边界
                        if (newWidth > imageCanvas.width * 0.9) {
                            newWidth = imageCanvas.width * 0.9;
                            newHeight = newWidth / cropRatio;
                        }
                        
                        if (newHeight > imageCanvas.height * 0.9) {
                            newHeight = imageCanvas.height * 0.9;
                            newWidth = newHeight * cropRatio;
                        }
                        
                        // 应用新尺寸
                        cropBox.style.width = newWidth + 'px';
                        cropBox.style.height = newHeight + 'px';
                    } else {
                        // 如果用户选择了预设比例，使用预设比例
                        updateCropBoxAspectRatio();
                    }
                    
                    // 计算新的中心点位置
                    let newCenterX, newCenterY;
                    const canvasCenterX = imageCanvas.width / 2;
                    const canvasCenterY = imageCanvas.height / 2;
                    
                    // 根据旋转角度计算新的中心点位置
                    if ((rotationAngle - prevAngle) % 180 !== 0) {
                        // 交换并可能翻转坐标
                        newCenterX = canvasCenterX + cropCenterRelativeY * canvasCenterX * (angle > 0 ? -1 : 1);
                        newCenterY = canvasCenterY + cropCenterRelativeX * canvasCenterY * (angle > 0 ? 1 : -1);
                    } else {
                        // 坐标保持不变
                        newCenterX = canvasCenterX + cropCenterRelativeX * canvasCenterX;
                        newCenterY = canvasCenterY + cropCenterRelativeY * canvasCenterY;
                    }
                    
                    // 计算左上角位置
                    const newCropWidth = parseInt(cropBox.style.width) || 0;
                    const newCropHeight = parseInt(cropBox.style.height) || 0;
                    const newLeft = newCenterX - newCropWidth / 2;
                    const newTop = newCenterY - newCropHeight / 2;
                    
                    // 确保在画布内
                    cropBox.style.left = Math.max(0, Math.min(newLeft, imageCanvas.width - newCropWidth)) + 'px';
                    cropBox.style.top = Math.max(0, Math.min(newTop, imageCanvas.height - newCropHeight)) + 'px';
                    
                    // 更新显示
                    updateCropDimensions();
                }
            }
            
            // 水平翻转
            function flipHorizontal() {
                isHorizontalFlipped = !isHorizontalFlipped;
                console.log("水平翻转：", isHorizontalFlipped);
                drawImage();
            }
            
            // 垂直翻转
            function flipVertical() {
                isVerticalFlipped = !isVerticalFlipped;
                console.log("垂直翻转：", isVerticalFlipped);
                drawImage();
            }
            
            // 更新裁剪框宽高比
            function updateCropBoxAspectRatio() {
                if (!cropBoxInitialized) return;
                
                const aspectRatio = aspectRatioSelect.value === 'free' ? null : getAspectRatioValue();
                console.log("更新裁剪比例：", aspectRatioSelect.value, aspectRatio);
                
                if (aspectRatio) {
                    // 获取当前裁剪框的位置和尺寸
                    const cropLeft = parseInt(cropBox.style.left) || 0;
                    const cropTop = parseInt(cropBox.style.top) || 0;
                    const cropWidth = parseInt(cropBox.style.width) || 100;
                    const cropHeight = parseInt(cropBox.style.height) || 100;
                    
                    // 计算裁剪框的中心点
                    const centerX = cropLeft + cropWidth / 2;
                    const centerY = cropTop + cropHeight / 2;
                    
                    // 根据当前宽度计算新的高度
                    let newWidth = cropWidth;
                    let newHeight = newWidth / aspectRatio;
                    
                    // 检查新高度是否会超出画布或位置不当
                    if (newHeight > imageCanvas.height || centerY - newHeight / 2 < 0 || centerY + newHeight / 2 > imageCanvas.height) {
                        // 如果高度不合适，改为基于画布高度计算
                        const maxPossibleHeight = Math.min(imageCanvas.height, Math.min(centerY * 2, (imageCanvas.height - centerY) * 2));
                        newHeight = maxPossibleHeight;
                        newWidth = newHeight * aspectRatio;
                        
                        // 检查新宽度是否也会超出
                        if (newWidth > imageCanvas.width || centerX - newWidth / 2 < 0 || centerX + newWidth / 2 > imageCanvas.width) {
                            // 如果宽度也不合适，找出能适应的最大尺寸
                            const maxPossibleWidth = Math.min(imageCanvas.width, Math.min(centerX * 2, (imageCanvas.width - centerX) * 2));
                            newWidth = maxPossibleWidth;
                            newHeight = newWidth / aspectRatio;
                        }
                    }
                    
                    // 计算新的左上角位置以保持中心点位置
                    const newLeft = Math.max(0, centerX - newWidth / 2);
                    const newTop = Math.max(0, centerY - newHeight / 2);
                    
                    // 最终检查确保不超出右边和底部边界
                    if (newLeft + newWidth > imageCanvas.width) {
                        newWidth = imageCanvas.width - newLeft;
                        newHeight = newWidth / aspectRatio;
                    }
                    
                    if (newTop + newHeight > imageCanvas.height) {
                        newHeight = imageCanvas.height - newTop;
                        newWidth = newHeight * aspectRatio;
                    }
                    
                    // 应用新的尺寸和位置
                    cropBox.style.width = newWidth + 'px';
                    cropBox.style.height = newHeight + 'px';
                    cropBox.style.left = newLeft + 'px';
                    cropBox.style.top = newTop + 'px';
                    
                    // 更新裁剪框尺寸显示
                    updateCropDimensions();
                }
            }
            
            // 获取宽高比值
            function getAspectRatioValue() {
                const ratio = aspectRatioSelect.value;
                if (ratio === 'free') return null;
                
                const [w, h] = ratio.split(':').map(Number);
                return w / h;
            }
            
            // 更新裁剪框尺寸显示
            function updateCropDimensions() {
                if (!cropBoxInitialized) return;
                
                const cropWidth = parseInt(cropBox.style.width) || 0;
                const cropHeight = parseInt(cropBox.style.height) || 0;
                
                if (cropWidth <= 0 || cropHeight <= 0) {
                    cropDimensions.textContent = "0 × 0";
                    return;
                }
                
                // 计算实际尺寸（考虑画布缩放）
                const scaleX = originalImage.width / imageCanvas.width;
                const scaleY = originalImage.height / imageCanvas.height;
                
                let actualWidth, actualHeight;
                
                if (rotationAngle % 180 === 0) {
                    actualWidth = Math.round(cropWidth * scaleX);
                    actualHeight = Math.round(cropHeight * scaleY);
                } else {
                    actualWidth = Math.round(cropWidth * scaleY);
                    actualHeight = Math.round(cropHeight * scaleX);
                }
                
                cropDimensions.textContent = `${actualWidth} × ${actualHeight}`;
                console.log("更新裁剪尺寸显示：", actualWidth, "x", actualHeight);
            }
            
            // 裁剪图像
            function cropImage() {
                if (!cropBoxInitialized || !originalImage) return;
                
                // 获取裁剪框位置和尺寸
                const cropLeft = parseInt(cropBox.style.left) || 0;
                const cropTop = parseInt(cropBox.style.top) || 0;
                const cropWidth = parseInt(cropBox.style.width) || 0;
                const cropHeight = parseInt(cropBox.style.height) || 0;
                
                console.log("裁剪区域：", cropLeft, cropTop, cropWidth, cropHeight);
                
                try {
                    // 计算相对于画布中心的位置
                    const canvasCenterX = imageCanvas.width / 2;
                    const canvasCenterY = imageCanvas.height / 2;
                    const cropCenterX = cropLeft + cropWidth / 2;
                    const cropCenterY = cropTop + cropHeight / 2;
                    
                    // 计算相对位置比例
                    const relativeX = (cropCenterX - canvasCenterX) / canvasCenterX;
                    const relativeY = (cropCenterY - canvasCenterY) / canvasCenterY;
                    
                    // 计算实际裁剪尺寸（考虑缩放比例）
                    let finalWidth, finalHeight;
                    
                    if (rotationAngle % 180 === 0) {
                        // 对于0°或180°旋转
                        finalWidth = Math.round(cropWidth / canvasScale);
                        finalHeight = Math.round(cropHeight / canvasScale);
                    } else {
                        // 对于90°或270°旋转，宽高需要交换
                        finalWidth = Math.round(cropHeight / canvasScale);
                        finalHeight = Math.round(cropWidth / canvasScale);
                    }
                    
                    // 创建输出画布
                    const resultCanvas = document.createElement('canvas');
                    const resultCtx = resultCanvas.getContext('2d');
                    resultCanvas.width = finalWidth;
                    resultCanvas.height = finalHeight;
                    
                    // 创建临时画布，应用所有变换
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // 使用足够大的尺寸
                    const maxDimension = Math.max(originalImage.width, originalImage.height) * 2;
                    tempCanvas.width = maxDimension;
                    tempCanvas.height = maxDimension;
                    
                    // 临时画布的中心
                    const tempCenterX = maxDimension / 2;
                    const tempCenterY = maxDimension / 2;
                    
                    // 将原始图像绘制到临时画布并应用变换
                    tempCtx.save();
                    tempCtx.translate(tempCenterX, tempCenterY);
                    tempCtx.rotate((rotationAngle * Math.PI) / 180);
                    tempCtx.scale(isHorizontalFlipped ? -1 : 1, isVerticalFlipped ? -1 : 1);
                    tempCtx.drawImage(
                        originalImage,
                        -originalImage.width / 2,
                        -originalImage.height / 2
                    );
                    tempCtx.restore();
                    
                    // 确定裁剪区域在临时画布上的位置
                    let sourceX, sourceY;
                    const originalCenterX = originalImage.width / 2;
                    const originalCenterY = originalImage.height / 2;
                    
                    switch (rotationAngle) {
                        case 0:
                            // 无旋转
                            sourceX = tempCenterX + relativeX * originalCenterX - finalWidth / 2;
                            sourceY = tempCenterY + relativeY * originalCenterY - finalHeight / 2;
                            break;
                        case 90:
                            // 旋转90度
                            sourceX = tempCenterX + relativeY * originalCenterY - finalWidth / 2;
                            sourceY = tempCenterY - relativeX * originalCenterX - finalHeight / 2;
                            break;
                        case 180:
                            // 旋转180度
                            sourceX = tempCenterX - relativeX * originalCenterX - finalWidth / 2;
                            sourceY = tempCenterY - relativeY * originalCenterY - finalHeight / 2;
                            break;
                        case 270:
                            // 旋转270度
                            sourceX = tempCenterX - relativeY * originalCenterY - finalWidth / 2;
                            sourceY = tempCenterY + relativeX * originalCenterX - finalHeight / 2;
                            break;
                        default:
                            // 其他角度（不应该出现）
                            sourceX = tempCenterX - finalWidth / 2;
                            sourceY = tempCenterY - finalHeight / 2;
                    }
                    
                    // 应用翻转的影响
                    if (isHorizontalFlipped) {
                        sourceX = tempCanvas.width - sourceX - finalWidth;
                    }
                    if (isVerticalFlipped) {
                        sourceY = tempCanvas.height - sourceY - finalHeight;
                    }
                    
                    // 从临时画布裁剪到结果画布
                    resultCtx.drawImage(
                        tempCanvas,
                        Math.round(sourceX), Math.round(sourceY), finalWidth, finalHeight,
                        0, 0, finalWidth, finalHeight
                    );
                    
                    // 显示预览
                    previewImage.src = resultCanvas.toDataURL('image/png');
                    finalDimensions.textContent = `${finalWidth} × ${finalHeight}`;
                    
                    console.log("裁剪完成，最终尺寸：", finalWidth, "x", finalHeight);
                    
                    // 显示预览容器
                    editorContainer.style.display = 'none';
                    previewContainer.style.display = 'block';
                } catch (error) {
                    console.error("裁剪过程中出错：", error);
                    alert("裁剪失败，请重试：" + error.message);
                }
            }
            
            // 下载裁剪后的图像
            function downloadImage() {
                if (!previewImage.src) return;
                
                // 创建下载链接
                const link = document.createElement('a');
                link.href = previewImage.src;
                link.download = 'cropped_image.png';
                
                // 触发下载
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // 重置编辑器
            function resetEditor() {
                editorContainer.style.display = 'block';
                previewContainer.style.display = 'none';
            }
        });
    </script>
    
</body>
</html> 